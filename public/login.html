<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - Nursery App</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@300..900&family=Plus+Jakarta+Sans:ital,wght@0,200..800;1,200..800&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="/assets/css/main.css">
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>

<body class="bg-earth-100 text-earth-900 antialiased" x-data="{ 
        email: '', 
        password: '', 
        loading: false, 
        error: null,
        
        async submit() {
            this.loading = true;
            this.error = null;
            
            try {
                const result = await Alpine.store('auth').login(this.email, this.password);
                if (result.success) {
                    showToast('Welcome back!', 'success');
                    
                    const user = Alpine.store('auth').user;
                    
                    // Get user role (check Spatie roles first, fallback to legacy role field)
                    const role = user.roles && user.roles.length > 0
                        ? user.roles[0].name
                        : user.role;

                    // Redirect based on role
                    if (['super_admin', 'admin', 'manager'].includes(role)) {
                        // Admin-level users → Admin Dashboard
                        window.location.href = '/admin-dashboard';
                    } else if (role === 'vendor') {
                        // Check vendor status
                        if (user.vendor) {
                            if (user.vendor.status === 'approved') {
                                // Approved vendors → Vendor Dashboard
                                window.location.href = '/vendor-dashboard';
                            } else if (user.vendor.status === 'pending') {
                                // Pending vendors → Pending page
                                window.location.href = '/vendor-pending';
                            } else {
                                // Rejected/suspended vendors
                                this.error = 'Your vendor account is ' + user.vendor.status + '. Please contact support.';
                                showToast(this.error, 'error');
                                return;
                            }
                        } else {
                            // Vendor role but no profile? Go to registration/home
                            window.location.href = '/';
                        }
                    } else {
                        // Customer or default → Profile page
                        window.location.href = '/profile';
                    }
                } else {
                    this.error = result.message;
                    showToast(result.message, 'error');
                }
            } catch (e) {
                this.error = 'An unexpected error occurred.';
            } finally {
                this.loading = false;
            }
        }
      }">

    <div id="header-placeholder"></div>

    <!-- Main Content -->
    <div class="min-h-screen pt-20 pb-12 flex flex-col justify-center sm:px-6 lg:px-8 relative overflow-hidden">
        <!-- Liquid Blobs -->
        <div
            class="absolute top-0 left-0 w-96 h-96 bg-primary-200 rounded-full mix-blend-multiply filter blur-3xl opacity-30 animate-blob">
        </div>
        <div
            class="absolute bottom-0 right-0 w-96 h-96 bg-secondary-200 rounded-full mix-blend-multiply filter blur-3xl opacity-30 animate-blob animation-delay-2000">
        </div>

        <div class="sm:mx-auto sm:w-full sm:max-w-md relative z-10">
            <div class="text-center mb-8">
                <div
                    class="mx-auto h-16 w-16 bg-primary-600 rounded-full flex items-center justify-center text-white shadow-lg mb-4">
                    <i data-lucide="leaf" class="w-8 h-8"></i>
                </div>
                <h2 class="text-3xl font-display font-bold text-earth-900">Welcome back</h2>
                <p class="mt-2 text-earth-600">Sign in to access your account</p>
            </div>

            <div class="glass-card py-8 px-4 shadow-2xl sm:rounded-2xl sm:px-10" data-aos="fade-up">
                <form class="space-y-6" @submit.prevent="submit">
                    <!-- Error Alert -->
                    <div x-show="error" x-transition class="bg-red-50 border-l-4 border-red-500 p-4 rounded-md mb-4">
                        <div class="flex">
                            <div class="flex-shrink-0">
                                <i data-lucide="alert-circle" class="h-5 w-5 text-red-400"></i>
                            </div>
                            <div class="ml-3">
                                <p class="text-sm text-red-700" x-text="error"></p>
                            </div>
                        </div>
                    </div>

                    <div>
                        <label for="email" class="block text-sm font-medium text-earth-700">Email address</label>
                        <div class="mt-1 relative">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <i data-lucide="mail" class="h-5 w-5 text-gray-400"></i>
                            </div>
                            <input id="email" name="email" type="email" autocomplete="email" required x-model="email"
                                class="appearance-none block w-full pl-10 pr-3 py-3 border border-gray-200 rounded-lg bg-white/50 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-all sm:text-sm">
                        </div>
                    </div>

                    <div>
                        <label for="password" class="block text-sm font-medium text-earth-700">Password</label>
                        <div class="mt-1 relative">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <i data-lucide="lock" class="h-5 w-5 text-gray-400"></i>
                            </div>
                            <input id="password" name="password" type="password" autocomplete="current-password"
                                required x-model="password"
                                class="appearance-none block w-full pl-10 pr-3 py-3 border border-gray-200 rounded-lg bg-white/50 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-all sm:text-sm">
                        </div>
                    </div>

                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <input id="remember-me" name="remember-me" type="checkbox"
                                class="h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300 rounded">
                            <label for="remember-me" class="ml-2 block text-sm text-earth-600">Remember me</label>
                        </div>

                        <div class="text-sm">
                            <a href="#" class="font-medium text-primary-600 hover:text-primary-500">Forgot your
                                password?</a>
                        </div>
                    </div>

                    <div>
                        <button type="submit" :disabled="loading"
                            class="btn-shine w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 disabled:opacity-50 disabled:cursor-not-allowed transition-all">
                            <i x-show="loading" data-lucide="loader-2" class="animate-spin -ml-1 mr-2 h-5 w-5"></i>
                            Sign in
                        </button>
                    </div>
                </form>

                <div class="mt-6">
                    <div class="relative">
                        <div class="absolute inset-0 flex items-center">
                            <div class="w-full border-t border-gray-200"></div>
                        </div>
                        <div class="relative flex justify-center text-sm">
                            <span class="px-2 bg-white text-gray-500 rounded">Or continue with</span>
                        </div>
                    </div>

                    <div class="mt-6">
                        <a href="/auth/google"
                            class="w-full inline-flex justify-center py-2.5 px-4 border border-gray-200 rounded-lg shadow-sm bg-white/50 text-sm font-medium text-earth-700 hover:bg-gray-50 transition-colors">
                            <svg class="h-5 w-5 mr-2" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                                <path
                                    d="M12.48 10.92v3.28h7.84c-.24 1.84-.853 3.187-1.787 4.133-1.147 1.147-2.933 2.4-6.053 2.4-4.827 0-8.6-3.893-8.6-8.72s3.773-8.72 8.6-8.72c2.6 0 4.507 1.027 5.907 2.347l2.307-2.307C18.747 1.44 16.133 0 12.48 0 5.867 0 .307 5.387.307 12s5.56 12 12.173 12c3.573 0 6.267-1.173 8.373-3.36 2.16-2.16 2.84-5.213 2.84-7.667 0-.76-.053-1.467-.173-2.053H12.48z" />
                            </svg>
                            <span>Sign in with Google</span>
                        </a>
                    </div>
                </div>
                <div class="mt-6 text-center">
                    <p class="text-sm text-earth-600">
                        Don't have an account?
                        <a href="/register" class="font-medium text-primary-600 hover:text-primary-500">Sign up
                            now</a>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js"></script>
    <script src="/assets/js/app.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            await window.loadComponents();
            lucide.createIcons();
            AOS.init();
        });
    </script>
    <div id="toast-placeholder"></div>
</body>

</html>