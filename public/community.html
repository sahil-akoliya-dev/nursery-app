<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Community - Nursery App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@300..900&family=Plus+Jakarta+Sans:ital,wght@0,200..800;1,200..800&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="/assets/css/main.css">
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js"></script>
    <script src="/assets/js/app.js"></script>
</head>

<body class="bg-earth-100 text-earth-900 antialiased" x-data="communityPage()">
    <div id="header-placeholder"></div>

    <!-- Main Content -->
    <div class="min-h-screen pt-32 pb-12 relative overflow-hidden">
        <!-- Liquid Blobs -->
        <div
            class="absolute top-0 right-0 w-96 h-96 bg-primary-200 rounded-full mix-blend-multiply filter blur-3xl opacity-30 animate-blob">
        </div>
        <div
            class="absolute bottom-0 left-0 w-96 h-96 bg-secondary-200 rounded-full mix-blend-multiply filter blur-3xl opacity-30 animate-blob animation-delay-2000">
        </div>

        <div class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8 relative z-10">
            <div class="flex justify-between items-center mb-8">
                <div>
                    <h1 class="text-3xl md:text-4xl font-display font-bold text-earth-900">Community Feed ðŸŒ¿</h1>
                    <p class="text-earth-600 mt-2">Connect with other plant lovers!</p>
                </div>
                <button @click="showCreateModal = true"
                    class="bg-primary-600 text-white px-6 py-3 rounded-full font-bold hover:bg-primary-700 transition-colors shadow-lg flex items-center gap-2">
                    <i data-lucide="plus-circle" class="w-5 h-5"></i> New Post
                </button>
            </div>

            <!-- Create Post Modal -->
            <div x-show="showCreateModal" class="fixed inset-0 z-50 flex items-center justify-center px-4" x-cloak>
                <div class="fixed inset-0 bg-black/50 backdrop-blur-sm transition-opacity"
                    @click="showCreateModal = false"></div>
                <div class="bg-white rounded-2xl w-full max-w-lg p-6 shadow-xl relative z-10 transform transition-all">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold text-earth-900">Create Post</h3>
                        <button @click="showCreateModal = false" class="text-gray-400 hover:text-gray-600">
                            <i data-lucide="x" class="w-6 h-6"></i>
                        </button>
                    </div>
                    <div class="space-y-4">
                        <textarea x-model="newPost.content" rows="4"
                            class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-primary-500 focus:border-transparent resize-none"
                            placeholder="Share something about your garden..."></textarea>
                        <input type="text" x-model="newPost.image_url"
                            class="w-full px-4 py-2 border border-gray-300 rounded-xl focus:ring-2 focus:ring-primary-500"
                            placeholder="Image URL (optional)">
                        <button @click="createPost" :disabled="loadingCreate"
                            class="w-full bg-primary-600 text-white py-3 rounded-xl font-bold hover:bg-primary-700 transition-colors disabled:opacity-50">
                            <span x-show="!loadingCreate">Post</span>
                            <span x-show="loadingCreate" class="animate-spin">âŒ›</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Feed -->
            <div x-show="loading" class="flex justify-center py-12">
                <div class="w-12 h-12 border-4 border-primary-200 border-t-primary-600 rounded-full animate-spin"></div>
            </div>

            <div x-show="!loading && posts.length === 0" class="text-center py-12 glass-card rounded-2xl">
                <i data-lucide="users" class="w-16 h-16 text-gray-300 mx-auto mb-4"></i>
                <p class="text-gray-500">No posts yet. Be the first to share!</p>
            </div>

            <div class="space-y-6" x-show="!loading">
                <template x-for="post in posts" :key="post.id">
                    <div class="glass-card p-6 rounded-2xl shadow-sm hover:shadow-md transition-shadow">
                        <!-- Post Header -->
                        <div class="flex items-center gap-3 mb-4">
                            <div
                                class="w-10 h-10 bg-primary-100 rounded-full flex items-center justify-center text-primary-600 font-bold">
                                <span x-text="post.user.name.charAt(0)"></span>
                            </div>
                            <div>
                                <h4 class="font-bold text-earth-900" x-text="post.user.name"></h4>
                                <p class="text-xs text-gray-500"
                                    x-text="new Date(post.created_at).toLocaleDateString()"></p>
                            </div>
                        </div>

                        <!-- Post Content -->
                        <p class="text-earth-800 mb-4 whitespace-pre-line" x-text="post.content"></p>
                        <template x-if="post.image_url">
                            <img :src="post.image_url" class="w-full h-64 object-cover rounded-xl mb-4">
                        </template>

                        <!-- Actions -->
                        <div class="flex items-center gap-6 border-t border-gray-100 pt-4">
                            <button @click="likePost(post)" class="flex items-center gap-2 transition-colors"
                                :class="post.is_liked ? 'text-red-500' : 'text-gray-500 hover:text-red-500'">
                                <i :data-lucide="post.is_liked ? 'heart' : 'heart'"
                                    :class="post.is_liked ? 'fill-current' : ''" class="w-5 h-5"></i>
                                <span x-text="post.likes_count"></span>
                            </button>
                            <button @click="toggleComments(post.id)"
                                class="flex items-center gap-2 text-gray-500 hover:text-primary-600 transition-colors">
                                <i data-lucide="message-circle" class="w-5 h-5"></i>
                                <span x-text="post.comments_count"></span>
                            </button>
                        </div>

                        <!-- Comments Section -->
                        <div x-show="activePostId === post.id"
                            class="mt-4 pt-4 border-t border-gray-100 bg-gray-50/50 rounded-xl p-4">
                            <div class="space-y-3 mb-4 max-h-60 overflow-y-auto custom-scrollbar">
                                <template x-for="comment in post.comments" :key="comment.id">
                                    <div class="flex gap-3">
                                        <div
                                            class="w-8 h-8 bg-gray-200 rounded-full flex-shrink-0 flex items-center justify-center text-xs font-bold text-gray-600">
                                            <span x-text="comment.user.name.charAt(0)"></span>
                                        </div>
                                        <div class="bg-white p-3 rounded-lg shadow-sm flex-1">
                                            <p class="text-xs font-bold text-earth-900 mb-1" x-text="comment.user.name">
                                            </p>
                                            <p class="text-sm text-gray-700" x-text="comment.content"></p>
                                        </div>
                                    </div>
                                </template>
                                <div x-show="post.comments.length === 0" class="text-center text-sm text-gray-500 py-2">
                                    No comments yet.
                                </div>
                            </div>

                            <div class="flex gap-2">
                                <input type="text" x-model="newComment" @keydown.enter="addComment(post)"
                                    class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 text-sm"
                                    placeholder="Write a comment...">
                                <button @click="addComment(post)" :disabled="loadingComment"
                                    class="p-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors disabled:opacity-50">
                                    <i data-lucide="send" class="w-4 h-4"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </template>
            </div>

            <!-- Load More -->
            <div class="mt-8 text-center" x-show="hasMore">
                <button @click="loadMore" class="text-primary-600 font-medium hover:text-primary-700">
                    Load More
                </button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('alpine:init', () => {
            Alpine.data('communityPage', () => ({
                posts: [],
                loading: true,
                loadingCreate: false,
                loadingComment: false,
                showCreateModal: false,
                newPost: { content: '', image_url: '' },
                activePostId: null,
                newComment: '',
                page: 1,
                hasMore: true,

                async init() {
                    loadHeader();
                    await this.fetchPosts();
                    this.$nextTick(() => {
                        lucide.createIcons();
                        AOS.init();
                    });
                },

                async fetchPosts(append = false) {
                    if (!append) this.loading = true;
                    try {
                        const token = localStorage.getItem('auth_token');
                        const response = await axios.get(`/api/community/posts?page=${this.page}`, {
                            headers: token ? { Authorization: `Bearer ${token}` } : {}
                        });

                        if (response.data.success) {
                            const newPosts = response.data.data.data;
                            if (append) {
                                this.posts = [...this.posts, ...newPosts];
                            } else {
                                this.posts = newPosts;
                            }
                            this.hasMore = response.data.data.next_page_url !== null;
                        }
                    } catch (e) {
                        console.error('Failed to fetch posts', e);
                    } finally {
                        this.loading = false;
                    }
                },

                async loadMore() {
                    this.page++;
                    await this.fetchPosts(true);
                    this.$nextTick(() => lucide.createIcons());
                },

                async createPost() {
                    if (!this.newPost.content) return;
                    this.loadingCreate = true;
                    try {
                        const token = localStorage.getItem('auth_token');
                        if (!token) {
                            window.location.href = '/login.html';
                            return;
                        }

                        const response = await axios.post('/api/community/posts', this.newPost, {
                            headers: { Authorization: `Bearer ${token}` }
                        });

                        if (response.data.success) {
                            this.posts.unshift({
                                ...response.data.data,
                                likes_count: 0,
                                comments_count: 0,
                                comments: [],
                                is_liked: false
                            });
                            this.showCreateModal = false;
                            this.newPost = { content: '', image_url: '' };
                            showToast('Post created! ðŸŒ¿', 'success');
                            this.$nextTick(() => lucide.createIcons());
                        }
                    } catch (e) {
                        showToast('Failed to create post', 'error');
                    } finally {
                        this.loadingCreate = false;
                    }
                },

                async likePost(post) {
                    const token = localStorage.getItem('auth_token');
                    if (!token) {
                        window.location.href = '/login.html';
                        return;
                    }

                    // Optimistic update
                    post.is_liked = !post.is_liked;
                    post.likes_count += post.is_liked ? 1 : -1;

                    try {
                        await axios.post(`/api/community/posts/${post.id}/like`, {}, {
                            headers: { Authorization: `Bearer ${token}` }
                        });
                    } catch (e) {
                        // Revert on failure
                        post.is_liked = !post.is_liked;
                        post.likes_count += post.is_liked ? 1 : -1;
                        showToast('Failed to like post', 'error');
                    }
                },

                toggleComments(postId) {
                    this.activePostId = this.activePostId === postId ? null : postId;
                },

                async addComment(post) {
                    if (!this.newComment) return;
                    const token = localStorage.getItem('auth_token');
                    if (!token) {
                        window.location.href = '/login.html';
                        return;
                    }

                    this.loadingComment = true;
                    try {
                        const response = await axios.post(`/api/community/posts/${post.id}/comment`,
                            { content: this.newComment },
                            { headers: { Authorization: `Bearer ${token}` } }
                        );

                        if (response.data.success) {
                            if (!post.comments) post.comments = [];
                            post.comments.push(response.data.data);
                            post.comments_count++;
                            this.newComment = '';
                        }
                    } catch (e) {
                        showToast('Failed to add comment', 'error');
                    } finally {
                        this.loadingComment = false;
                    }
                }
            }));
        });
    </script>
</body>

</html>