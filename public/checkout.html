<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout - Nursery App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@300..900&family=Plus+Jakarta+Sans:ital,wght@0,200..800;1,200..800&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="/assets/css/main.css">
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
</head>

<body class="bg-earth-100 text-earth-900 antialiased">

    <!-- Navigation (Simplified) -->
    <div id="header-placeholder"></div>

    <!-- Checkout Content -->
    <div class="pt-32 pb-20 max-w-7xl mx-auto px-4 sm:px-6 lg:px-8" x-data="{
            step: 1,
            loading: false,
            error: null,
            formData: {
                email: '',
                firstName: '',
                lastName: '',
                phone: '',
                address: '',
                city: '',
                state: '',
                zip: '',
                country: '',
                cardName: '',
                cardNumber: '',
                expiry: '',
                cvc: '',
                paymentMethod: 'cod' // Default to COD
            },
            loadingCoupon: false,
            loadingPoints: false,
            couponCode: '',
            redeemPoints: '',
            loyaltyBalance: 0,
            appliedDiscount: null,
            savedAddresses: [],
            selectedAddressId: null,
            showNewAddressForm: false,
            
            async init() {
                // Check if cart is empty
                if (this.$store.cart.items.length === 0) {
                    window.location.href = '/shop.html';
                    return;
                }

                await this.fetchLoyaltyBalance();
                await this.fetchAddresses();

                // Pre-fill from user profile if logged in
                const user = Alpine.store('auth').user;
                if (user) {
                }
            },

            async fetchAddresses() {
                try {
                    const response = await api.get('/addresses');
                    if (response.data.data) {
                        this.savedAddresses = response.data.data;
                    }
                } catch (error) {
                    console.error('Failed to fetch addresses:', error);
                }
            },

            selectAddress(address) {
                this.selectedAddressId = address.id;
                this.showNewAddressForm = false;
                
                // Auto-fill form
                this.formData.firstName = address.first_name || '';
                this.formData.lastName = address.last_name || '';
                this.formData.phone = address.phone || '';
                this.formData.address = address.address_line1 + (address.address_line2 ? ', ' + address.address_line2 : '');
                this.formData.city = address.city || '';
                this.formData.state = address.state || '';
                this.formData.zip = address.postal_code || '';
                this.formData.country = address.country || '';
            },

            useNewAddress() {
                this.selectedAddressId = null;
                this.showNewAddressForm = true;
                // Clear form but keep email/name from profile if available
                const user = Alpine.store('auth').user;
                this.formData.address = '';
                this.formData.city = '';
                this.formData.state = '';
                this.formData.zip = '';
                this.formData.phone = '';
                this.formData.country = '';
            },

            validateShipping() {
                if (!this.formData.email || !this.formData.firstName || !this.formData.lastName || 
                    !this.formData.address || !this.formData.city || !this.formData.zip || !this.formData.country) {
                    this.error = 'Please fill in all required shipping fields.';
                    return false;
                }
                this.error = null;
                return true;
            },

            validatePayment() {
                if (this.formData.paymentMethod === 'stripe') {
                    if (!this.formData.cardName || !this.formData.cardNumber || !this.formData.expiry || !this.formData.cvc) {
                        this.error = 'Please fill in all card details.';
                        return false;
                    }
                }
                this.error = null;
                return true;
            },

            async completeOrder() {
                if (!this.validatePayment()) return;

                this.loading = true;
                this.error = null;
                
                // Construct payload matching CreateOrderRequest
                const payload = {
                    shipping_address: {
                        first_name: this.formData.firstName,
                        last_name: this.formData.lastName,
                        email: this.formData.email,
                        phone: this.formData.phone,
                        address: this.formData.address,
                        city: this.formData.city,
                        state: this.formData.state,
                        zip: this.formData.zip,
                        country: this.formData.country
                    },
                    billing_address: { // Reuse shipping for billing for simplicity
                        first_name: this.formData.firstName,
                        last_name: this.formData.lastName,
                        email: this.formData.email,
                        phone: this.formData.phone,
                        address: this.formData.address,
                        city: this.formData.city,
                        state: this.formData.state,
                        zip: this.formData.zip,
                        country: this.formData.country
                    },
                    payment_method: this.formData.paymentMethod,
                    notes: ''
                };

                try {
                    const response = await api.post('/orders', payload);
                    
                    if (response.data.success || response.status === 201) {
                        Alpine.store('cart').clear();
                        window.location.href = '/order-success.html'; 
                    } else {
                        throw new Error(response.data.message || 'Order failed');
                    }
                } catch (error) {
                    console.error('Order failed:', error);
                    this.error = error.response?.data?.message || 'Failed to place order. Please try again.';
                } finally {
                    this.loading = false;
                }
            }
         }">

        <div class="flex flex-col lg:flex-row gap-12">

            <!-- Forms -->
            <div class="flex-1">
                <!-- Steps Indicator -->
                <div class="flex items-center mb-8 text-sm font-medium">
                    <span :class="step >= 1 ? 'text-primary-600' : 'text-gray-400'">Shipping</span>
                    <i data-lucide="chevron-right" class="w-4 h-4 mx-2 text-gray-300"></i>
                    <span :class="step >= 2 ? 'text-primary-600' : 'text-gray-400'">Payment</span>
                    <i data-lucide="chevron-right" class="w-4 h-4 mx-2 text-gray-300"></i>
                    <span :class="step >= 3 ? 'text-primary-600' : 'text-gray-400'">Review</span>
                </div>

                <!-- Error Alert -->
                <div x-show="error" x-transition
                    class="mb-6 bg-red-50 border border-red-200 text-red-600 px-4 py-3 rounded-lg flex items-center gap-2">
                    <i data-lucide="alert-circle" class="w-5 h-5"></i>
                    <span x-text="error"></span>
                </div>

                <!-- Step 1: Shipping -->
                <div x-show="step === 1" x-transition:enter="transition ease-out duration-300"
                    x-transition:enter-start="opacity-0 translate-y-4"
                    x-transition:enter-end="opacity-100 translate-y-0" class="glass-card p-8 rounded-2xl shadow-sm">
                    <h2 class="text-2xl font-display font-bold text-earth-900 mb-6">Shipping Details</h2>

                    <!-- Saved Addresses Selector -->
                    <div x-show="savedAddresses.length > 0" class="mb-8">
                        <h3 class="font-bold text-gray-700 mb-4 flex items-center gap-2">
                            <i data-lucide="map-pin" class="w-5 h-5 text-primary-600"></i>
                            Select a Saved Address
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <template x-for="addr in savedAddresses" :key="addr.id">
                                <div @click="selectAddress(addr)"
                                    class="cursor-pointer border rounded-xl p-4 transition-all hover:border-primary-300 relative"
                                    :class="selectedAddressId === addr.id ? 'border-primary-600 bg-primary-50 ring-1 ring-primary-600' : 'border-gray-200 bg-white'">

                                    <div class="flex justify-between items-start mb-2">
                                        <span class="font-bold text-earth-900" x-text="addr.type.toUpperCase()"></span>
                                        <div x-show="selectedAddressId === addr.id"
                                            class="w-5 h-5 bg-primary-600 rounded-full flex items-center justify-center text-white">
                                            <i data-lucide="check" class="w-3 h-3"></i>
                                        </div>
                                    </div>

                                    <p class="text-sm text-gray-600" x-text="addr.address_line1"></p>
                                    <p class="text-sm text-gray-600"
                                        x-text="addr.city + ', ' + addr.state + ' ' + addr.postal_code"></p>
                                    <p class="text-sm text-gray-500 mt-2" x-text="addr.phone"></p>
                                </div>
                            </template>

                            <div @click="useNewAddress()"
                                class="cursor-pointer border-2 border-dashed rounded-xl p-4 flex flex-col items-center justify-center gap-2 text-gray-500 hover:text-primary-600 hover:border-primary-300 hover:bg-gray-50 transition-all"
                                :class="showNewAddressForm ? 'border-primary-600 bg-primary-50 text-primary-600' : 'border-gray-300'">
                                <i data-lucide="plus" class="w-6 h-6"></i>
                                <span class="font-medium">Use a New Address</span>
                            </div>
                        </div>
                    </div>

                    <div x-show="savedAddresses.length === 0 || showNewAddressForm || selectedAddressId" x-transition
                        class="grid grid-cols-1 md:grid-cols-2 gap-6 pt-4 border-t border-gray-100">
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Email Address *</label>
                            <input type="email" x-model="formData.email" required
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-all">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">First Name *</label>
                            <input type="text" x-model="formData.firstName" required
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-all">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Last Name *</label>
                            <input type="text" x-model="formData.lastName" required
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-all">
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Phone Number *</label>
                            <input type="tel" x-model="formData.phone" required
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-all">
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Address *</label>
                            <input type="text" x-model="formData.address" required
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-all">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">City *</label>
                            <input type="text" x-model="formData.city" required
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-all">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">State *</label>
                            <input type="text" x-model="formData.state" required
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-all">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">ZIP Code *</label>
                            <input type="text" x-model="formData.zip" required
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-all">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Country *</label>
                            <select x-model="formData.country" required
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-all">
                                <option value="">Select Country</option>
                                <option value="US">United States</option>
                                <option value="UK">United Kingdom</option>
                                <option value="CA">Canada</option>
                                <option value="AU">Australia</option>
                            </select>
                        </div>
                    </div>
                    <div class="mt-8 flex justify-end">
                        <button @click="if(validateShipping()) step = 2"
                            class="bg-primary-600 text-white px-8 py-3 rounded-full font-bold hover:bg-primary-700 transition-colors shadow-lg hover:shadow-xl transform hover:-translate-y-0.5">
                            Continue to Payment
                        </button>
                    </div>
                </div>

                <!-- Step 2: Payment -->
                <div x-show="step === 2" x-transition:enter="transition ease-out duration-300"
                    x-transition:enter-start="opacity-0 translate-y-4"
                    x-transition:enter-end="opacity-100 translate-y-0" class="glass-card p-8 rounded-2xl shadow-sm"
                    x-cloak>

                    <!-- Coupon / Gift Card Section -->
                    <div class="mb-8 p-6 bg-primary-50 rounded-xl border border-primary-100">
                        <h3 class="font-bold text-earth-900 mb-4 flex items-center gap-2">
                            <i data-lucide="ticket" class="w-5 h-5 text-primary-600"></i>
                            Have a Coupon or Gift Card?
                        </h3>
                        <div class="flex gap-3">
                            <input type="text" x-model="couponCode" placeholder="Enter code"
                                class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent uppercase">
                            <button @click="applyCode" :disabled="loadingCoupon"
                                class="px-6 py-2 bg-earth-900 text-white rounded-lg hover:bg-earth-800 transition-colors disabled:opacity-50">
                                <span x-show="!loadingCoupon">Apply</span>
                                <span x-show="loadingCoupon" class="animate-spin">⌛</span>
                            </button>
                        </div>
                        <div x-show="appliedDiscount"
                            class="mt-3 flex justify-between items-center text-sm text-green-700 bg-green-50 p-3 rounded-lg border border-green-200">
                            <span class="flex items-center gap-2">
                                <i data-lucide="check-circle" class="w-4 h-4"></i>
                                <span x-text="appliedDiscount.description"></span> applied!
                            </span>
                            <button @click="removeDiscount"
                                class="text-red-500 hover:text-red-700 font-medium">Remove</button>
                        </div>
                    </div>

                    <!-- Loyalty Points Redemption -->
                    <div class="mb-8 p-6 bg-yellow-50 rounded-xl border border-yellow-100" x-show="loyaltyBalance > 0">
                        <h3 class="font-bold text-earth-900 mb-2 flex items-center gap-2">
                            <i data-lucide="star" class="w-5 h-5 text-yellow-500"></i>
                            Redeem Loyalty Points
                        </h3>
                        <p class="text-sm text-gray-600 mb-4">You have <span class="font-bold"
                                x-text="loyaltyBalance"></span> points available.</p>

                        <div class="flex gap-3">
                            <input type="number" x-model="redeemPoints" placeholder="Points to redeem" min="100"
                                :max="loyaltyBalance"
                                class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent">
                            <button @click="applyPoints" :disabled="loadingPoints"
                                class="px-6 py-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600 transition-colors disabled:opacity-50 font-medium">
                                <span x-show="!loadingPoints">Redeem</span>
                                <span x-show="loadingPoints" class="animate-spin">⌛</span>
                            </button>
                        </div>
                        <p class="text-xs text-gray-500 mt-2">100 points = ₹1.00 discount</p>
                    </div>

                    <h2 class="text-2xl font-display font-bold text-earth-900 mb-6">Payment Method</h2>

                    <!-- Payment Options -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
                        <div @click="formData.paymentMethod = 'cod'"
                            :class="formData.paymentMethod === 'cod' ? 'border-primary-500 bg-primary-50 ring-1 ring-primary-500' : 'border-gray-200 hover:border-primary-200'"
                            class="cursor-pointer border rounded-xl p-4 flex items-center gap-4 transition-all">
                            <div class="w-5 h-5 rounded-full border flex items-center justify-center"
                                :class="formData.paymentMethod === 'cod' ? 'border-primary-600' : 'border-gray-300'">
                                <div x-show="formData.paymentMethod === 'cod'"
                                    class="w-3 h-3 rounded-full bg-primary-600"></div>
                            </div>
                            <div>
                                <span class="block font-bold text-earth-900">Cash on Delivery</span>
                                <span class="text-sm text-gray-500">Pay when you receive</span>
                            </div>
                            <i data-lucide="banknote" class="w-6 h-6 text-gray-400 ml-auto"></i>
                        </div>

                        <div @click="formData.paymentMethod = 'stripe'"
                            :class="formData.paymentMethod === 'stripe' ? 'border-primary-500 bg-primary-50 ring-1 ring-primary-500' : 'border-gray-200 hover:border-primary-200'"
                            class="cursor-pointer border rounded-xl p-4 flex items-center gap-4 transition-all">
                            <div class="w-5 h-5 rounded-full border flex items-center justify-center"
                                :class="formData.paymentMethod === 'stripe' ? 'border-primary-600' : 'border-gray-300'">
                                <div x-show="formData.paymentMethod === 'stripe'"
                                    class="w-3 h-3 rounded-full bg-primary-600"></div>
                            </div>
                            <div>
                                <span class="block font-bold text-earth-900">Credit Card</span>
                                <span class="text-sm text-gray-500">Secure payment</span>
                            </div>
                            <i data-lucide="credit-card" class="w-6 h-6 text-gray-400 ml-auto"></i>
                        </div>
                    </div>

                    <!-- Card Details (Only if Stripe selected) -->
                    <div x-show="formData.paymentMethod === 'stripe'" x-transition
                        class="space-y-6 border-t pt-6 border-gray-100">
                        <div
                            class="mb-4 p-4 border border-blue-100 bg-blue-50 rounded-lg flex items-center gap-3 text-blue-700">
                            <i data-lucide="info" class="w-5 h-5"></i>
                            <p class="text-sm">This is a demo. No real charge will be made.</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Cardholder Name</label>
                            <input type="text" x-model="formData.cardName"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Card Number</label>
                            <div class="relative">
                                <input type="text" x-model="formData.cardNumber" placeholder="0000 0000 0000 0000"
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent">
                                <i data-lucide="credit-card" class="absolute right-3 top-2.5 w-5 h-5 text-gray-400"></i>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Expiry Date</label>
                                <input type="text" x-model="formData.expiry" placeholder="MM/YY"
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">CVC</label>
                                <input type="text" x-model="formData.cvc" placeholder="123"
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent">
                            </div>
                        </div>
                    </div>

                    <div class="mt-8 flex justify-between items-center">
                        <button @click="step = 1"
                            class="text-gray-500 font-medium hover:text-earth-900 flex items-center gap-2 transition-colors">
                            <i data-lucide="arrow-left" class="w-4 h-4"></i> Back
                        </button>
                        <button @click="completeOrder()"
                            class="bg-primary-600 text-white px-8 py-3 rounded-full font-bold hover:bg-primary-700 transition-colors flex items-center gap-2 shadow-lg hover:shadow-xl transform hover:-translate-y-0.5"
                            :disabled="loading" :class="loading ? 'opacity-75 cursor-not-allowed' : ''">
                            <span x-show="!loading">Place Order</span>
                            <span x-show="loading" class="flex items-center gap-2">
                                <span
                                    class="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></span>
                                Processing...
                            </span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Order Summary Sidebar -->
            <div class="w-full lg:w-96">
                <div class="glass-card p-6 rounded-2xl shadow-sm sticky top-32">
                    <h3 class="font-bold text-earth-900 mb-4 text-lg">Order Summary</h3>

                    <!-- Cart Items -->
                    <div class="space-y-4 mb-6 max-h-64 overflow-y-auto custom-scrollbar pr-2">
                        <template x-for="item in $store.cart.items" :key="item.id">
                            <div class="flex gap-4 group">
                                <div
                                    class="w-16 h-16 bg-gray-100 rounded-lg overflow-hidden flex-shrink-0 border border-gray-100">
                                    <img :src="item.image || item.images[0]"
                                        class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-500">
                                </div>
                                <div class="flex-1">
                                    <h4 class="text-sm font-bold text-earth-900 line-clamp-1" x-text="item.name"></h4>
                                    <p class="text-xs text-gray-500 mt-1" x-text="'Qty: ' + item.quantity"></p>
                                    <span class="font-medium"
                                        x-text="'₹' + (item.price * item.quantity).toFixed(2)"></span>
                                </div>
                            </div>
                        </template>
                        <div x-show="$store.cart.items.length === 0" class="text-center py-8 text-gray-500">
                            Your cart is empty.
                        </div>
                    </div>

                    <!-- Totals -->
                    <div class="border-t border-gray-100 pt-4 space-y-3">
                        <div class="flex justify-between text-sm text-gray-600">
                            <span>Subtotal</span>
                            <span x-text="'₹' + $store.cart.total.toFixed(2)"></span>
                        </div>
                        <div class="flex justify-between text-sm text-gray-600">
                            <span>Shipping</span>
                            <span class="text-green-600 font-medium">Free</span>
                        </div>
                        <div class="flex justify-between text-sm text-gray-600">
                            <span>Tax (8%)</span>
                            <span x-text="'₹' + ($store.cart.total * 0.08).toFixed(2)"></span>
                        </div>
                        <div x-show="appliedDiscount" class="flex justify-between text-sm text-green-600 font-medium">
                            <span>Discount</span>
                            <span x-text="'-₹' + appliedDiscount.amount.toFixed(2)"></span>
                        </div>
                        <div
                            class="border-t border-dashed border-gray-200 pt-3 flex justify-between text-xl font-bold text-earth-900">
                            <span>Total</span>
                            <span x-text="'₹' + calculateTotal()"></span>
                        </div>
                    </div>

                    <!-- Security Badge -->
                    <div
                        class="mt-6 flex items-center justify-center gap-2 text-xs text-gray-400 bg-gray-50 py-2 rounded-lg">
                        <i data-lucide="lock" class="w-3 h-3"></i>
                        Secure Checkout
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="footer-placeholder"></div>

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js"></script>
    <script src="/assets/js/app.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            await window.loadComponents();
            lucide.createIcons();
            AOS.init();
        });
    </script>
    <div id="toast-placeholder"></div>
</body>

</html>